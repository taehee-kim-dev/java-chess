<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>인비의 체스게임</title>
</head>
<style>
  .cell {
      height: 80px;
  }
  .status {
      height: 50px;
  }
  .content {
      display: table-cell;
      vertical-align: middle;
  }
  #current-turn-team-name {
      margin-bottom: 40px;
  }
  .piece-cell {
      cursor: pointer;
  }
</style>
<body>

<h1 style="text-align: center; margin-top: 77px; margin-bottom: 50px;">인비의 체스 게임</h1>

<div id="chess-board" style="text-align: center; width: 720px; margin-left: auto; margin-right: auto">
  {{#responseDTO}}
  <div id="current-status">
    <div id="current-scores" style="display: flex">
      <div class="score status content" style="flex: 1">백 팀 : {{whitePlayerScore}}점</div>
      <div class="score status content" style="flex: 1">흑 팀 : {{blackPlayerScore}}점</div>
    </div>
    <div id="current-turn-team-name">현재 차례 : {{currentTurnTeamName}} 팀</div>
  </div>
  {{/responseDTO}}
  <div class="rank" style="display: flex">
    <div class="cell left-side content" style="flex: 1">
      8
    </div>
    {{#rank8}}
    <div class="cell piece-cell content" style="flex: 1">
      {{.}}
    </div>
    {{/rank8}}
  </div>

  <div class="rank" style="display: flex">
    <div class="cell left-side content" style="flex: 1">
      7
    </div>
    {{#rank7}}
    <div class="cell piece-cell content" style="flex: 1">
      {{.}}
    </div>
    {{/rank7}}
  </div>

  <div class="rank" style="display: flex">
    <div class="cell left-side content" style="flex: 1">
      6
    </div>
    {{#rank6}}
    <div class="cell piece-cell content" style="flex: 1">
      {{.}}
    </div>
    {{/rank6}}
  </div>

  <div class="rank" style="display: flex">
    <div class="cell left-side content" style="flex: 1">
      5
    </div>
    {{#rank5}}
    <div class="cell piece-cell content" style="flex: 1">
      {{.}}
    </div>
    {{/rank5}}
  </div>

  <div class="rank" style="display: flex">
    <div class="cell left-side content" content style="flex: 1">
      4
    </div>
    {{#rank4}}
    <div class="cell piece-cell content" style="flex: 1">
      {{.}}
    </div>
    {{/rank4}}
  </div>

  <div class="rank" style="display: flex">
    <div class="cell left-side content" style="flex: 1">
      3
    </div>
    {{#rank3}}
    <div class="cell piece-cell content" style="flex: 1">
      {{.}}
    </div>
    {{/rank3}}
  </div>

  <div class="rank" style="display: flex">
    <div class="cell left-side content" style="flex: 1">
      2
    </div>
    {{#rank2}}
    <div class="cell piece-cell content" style="flex: 1">
      {{.}}
    </div>
    {{/rank2}}
  </div>

  <div class="rank" style="display: flex">
    <div class="cell left-side content" style="flex: 1">
      1
    </div>
    {{#rank1}}
    <div class="cell piece-cell content" style="flex: 1">
      {{.}}
    </div>
    {{/rank1}}
  </div>

  <div class="rank" style="display: flex">
    <div class="cell left-side bottom-side content" style="flex: 1">
      X
    </div>
    <div class="cell bottom-side content" style="flex: 1">
      a
    </div>
    <div class="cell bottom-side content" style="flex: 1">
      b
    </div>
    <div class="cell bottom-side content" style="flex: 1">
      c
    </div>
    <div class="cell bottom-side content" style="flex: 1">
      d
    </div>
    <div class="cell bottom-side content" style="flex: 1">
      e
    </div>
    <div class="cell bottom-side content" style="flex: 1">
      f
    </div>
    <div class="cell bottom-side content" style="flex: 1">
      g
    </div>
    <div class="cell bottom-side content" style="flex: 1">
      h
    </div>
  </div>
</div>

<form method="post" action="/move">
  <input type="text" name="startPosition">
  <input type="text" name="destination">
  <input type="submit" value="기물 이동">
</form>

<form action="/end" onsubmit="return endConfirm();">
  <input type="submit" value="게임 종료">
</form>


{{#responseDTO}}
<div id="is-king-dead" style="display: none">{{isKingDead}}</div>
<div id="before-turn-team-name" style="display: none">{{beforeTurnTeamName}}</div>
{{/responseDTO}}

<script type="text/javascript">
  const piece_cells = document.getElementsByClassName("piece-cell");

  const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
  const files_size_in_one_rank = files.length;
  let current_rank = 8;
  let current_file_index = 0;
  for (let i = 0; i < piece_cells.length; i++) {
    piece_cells[i].id = files[current_file_index] + String(current_rank);
    current_file_index += 1;
    if ((i + 1) % files_size_in_one_rank === 0) {
      current_rank -= 1;
      current_file_index = 0;
    }
  }

  let is_start_position_clicked = false;
  let start_position = null;
  let destination = null;

  for (let i = 0; i < piece_cells.length; i++) {
    piece_cells[i].addEventListener('click', (event) => {
      if (!is_start_position_clicked) {
        start_position = event.target.id;
        is_start_position_clicked = true;
        return;
      }
      destination = event.target.id;
      request_move_post();
    });
  }

  function request_move_post() {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'http://localhost:8080/move', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.responseType = 'json';
    xhr.send(JSON.stringify({
      startPosition: start_position,
      destination: destination
    }));
    start_position = null;
    destination = null;
    is_start_position_clicked = false;
    xhr.onload = function () {
      const move_response = xhr.response;
      if (move_response['isMoveError']) {
        alert(move_response['errorMessage']);
        return;
      }
      window.location.href='http://localhost:8080/chess-board';
    };
  }

  const is_king_dead = document.getElementById('is-king-dead');
  if (is_king_dead.innerText === "true") {
    const before_turn_team_name = document.getElementById('before-turn-team-name');
    alert(before_turn_team_name.innerText + ' 팀이 이겼습니다.');
    window.location.href='http://localhost:8080';
  }


  function endConfirm() {
    const is_end = confirm('정말 나가시겠습니까?');
    if (is_end === true) {
      alert('게임이 종료되었습니다.');
      return true;
    }
    return false;
  }
</script>
</body>
</html>